name: Documentation CI

on:
  push:
    branches: [ main, add-ci ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate docker-compose configuration
      run: docker compose -f docker-compose.docs.yml config

    - name: Build Docker images
      run: docker compose -f docker-compose.docs.yml build docs-dev

    - name: Start development server
      run: docker compose -f docker-compose.docs.yml up -d docs-dev

    - name: Wait for server to be ready
      run: |
        echo "Waiting for server to start..."
        timeout 120 bash -c 'until curl -f http://localhost:3006/ > /dev/null 2>&1; do sleep 5; done' || echo "Server didn't start in time"

    - name: Check container logs
      if: always()
      run: docker compose -f docker-compose.docs.yml logs docs-dev

    - name: Test server response
      run: |
        echo "Testing aicser-docs-dev..."
        curl -f http://localhost:3006/ || exit 1

    - name: Cleanup
      if: always()
      run: docker compose -f docker-compose.docs.yml down -v

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build production Docker image
      run: docker compose -f docker-compose.docs.yml build docs

    - name: Test production build
      run: |
        docker compose -f docker-compose.docs.yml up -d docs
        sleep 30
        curl -f http://localhost:3005/ || exit 1
        docker compose -f docker-compose.docs.yml down
